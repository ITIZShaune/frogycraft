import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, doc, onSnapshot, updateDoc, increment, setDoc, getDoc, serverTimestamp } from 'firebase/firestore';
import { Plus, Check, Users, Shield, Zap, Clock } from 'lucide-react';

// Configuration Firebase
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'shbot-app';

export default function App() {
  const [user, setUser] = useState(null);
  const [totalVotes, setTotalVotes] = useState(0);
  const [loading, setLoading] = useState(true);
  const [timeLeft, setTimeLeft] = useState(0); // Temps restant en secondes
  const [isSyncing, setIsSyncing] = useState(false);

  const VOTE_COOLDOWN = 3600; // 1 heure en secondes

  // 1. Authentification (RÈGLE 3)
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Erreur d'authentification:", error);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
    });
    return () => unsubscribe();
  }, []);

  // 2. Synchronisation des votes et vérification du délai (RÈGLE 1 & 2)
  useEffect(() => {
    if (!user) return;

    // Récupérer le total des votes (Public)
    const globalRef = doc(db, 'artifacts', appId, 'public', 'data', 'counters', 'globalVotes');
    const unsubGlobal = onSnapshot(globalRef, (snap) => {
      if (snap.exists()) setTotalVotes(snap.data().count || 0);
      else setDoc(globalRef, { count: 0 }, { merge: true });
      setLoading(false);
    });

    // Vérifier le dernier vote de l'utilisateur (Privé - RÈGLE 1)
    const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'votingState');
    const unsubUser = onSnapshot(userRef, (snap) => {
      if (snap.exists() && snap.data().lastVoteAt) {
        const lastVote = snap.data().lastVoteAt.toMillis();
        const now = Date.now();
        const diff = Math.floor((now - lastVote) / 1000);
        
        if (diff < VOTE_COOLDOWN) {
          setTimeLeft(VOTE_COOLDOWN - diff);
        }
      }
    });

    return () => {
      unsubGlobal();
      unsubUser();
    };
  }, [user]);

  // 3. Gestionnaire de compte à rebours
  useEffect(() => {
    if (timeLeft <= 0) return;
    const timer = setInterval(() => {
      setTimeLeft((prev) => prev - 1);
    }, 1000);
    return () => clearInterval(timer);
  }, [timeLeft]);

  const handleVote = async () => {
    if (timeLeft > 0 || !user || isSyncing) return;
    setIsSyncing(true);

    try {
      const globalRef = doc(db, 'artifacts', appId, 'public', 'data', 'counters', 'globalVotes');
      const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'votingState');

      // Mise à jour atomique du total et du timestamp utilisateur
      await updateDoc(globalRef, { count: increment(1) });
      await setDoc(userRef, { lastVoteAt: serverTimestamp() }, { merge: true });
      
      setTimeLeft(VOTE_COOLDOWN);
    } catch (error) {
      console.error("Erreur lors du vote:", error);
    } finally {
      setIsSyncing(false);
    }
  };

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
  };

  return (
    <div className="min-h-screen bg-[#0a0c10] text-white font-['Plus_Jakarta_Sans'] selection:bg-indigo-500/30">
      <div className="fixed inset-0 overflow-hidden pointer-events-none">
        <div className="absolute top-[-15%] left-[-10%] w-[50%] h-[50%] bg-indigo-600/5 blur-[120px] rounded-full"></div>
        <div className="absolute bottom-[-15%] right-[-10%] w-[50%] h-[50%] bg-blue-600/5 blur-[120px] rounded-full"></div>
      </div>

      <main className="relative z-10 max-w-6xl mx-auto px-6 py-24 flex flex-col items-center">
        <div className="mb-14 group">
          <img 
            src="https://cdn.discordapp.com/avatars/1441774756687777802/e80a2f1d14971eb838f807e1ee02d370.png?size=512" 
            alt="ShBot Avatar"
            className="w-44 h-44 rounded-[48px] shadow-2xl shadow-indigo-500/10 border border-white/5 transition-all duration-700 group-hover:scale-105 group-hover:rotate-2"
          />
        </div>

        <h1 className="text-7xl md:text-9xl font-extrabold tracking-tighter mb-6 bg-gradient-to-b from-white via-white to-slate-500 bg-clip-text text-transparent">
          ShBot
        </h1>
        
        <p className="text-xl md:text-2xl text-slate-400 max-w-2xl text-center mb-14 font-light leading-relaxed">
          La solution <span className="text-indigo-400 font-medium">All-in-One</span> pour votre serveur. 
          Modération, divertissement et outils système dans une interface unique.
        </p>

        <div className="flex flex-col sm:flex-row items-center gap-6 mb-24">
          <a 
            href="https://discord.com/oauth2/authorize?client_id=1441774756687777802&permissions=8&integration_type=0&scope=bot+applications.commands"
            target="_blank"
            className="group flex items-center gap-3 bg-indigo-600 hover:bg-indigo-500 transition-all px-10 py-5 rounded-2xl font-bold text-xl shadow-xl shadow-indigo-600/20 active:scale-95"
          >
            <Plus size={24} className="group-hover:rotate-90 transition-transform" />
            Ajouter à Discord
          </a>

          <button 
            onClick={handleVote}
            disabled={timeLeft > 0 || loading || isSyncing}
            className={`relative overflow-hidden flex items-center gap-4 px-10 py-5 rounded-2xl font-bold text-xl transition-all border ${
              timeLeft > 0 
              ? 'bg-white/5 border-white/10 text-slate-500 cursor-not-allowed' 
              : 'bg-white/5 border-white/10 hover:bg-white/10 text-white active:scale-95 hover:border-indigo-500/50'
            }`}
          >
            {timeLeft > 0 ? (
              <>
                <Clock size={24} className="text-slate-500" />
                <span>Recharge : {formatTime(timeLeft)}</span>
              </>
            ) : (
              <>
                <Zap size={24} className="text-yellow-400 fill-yellow-400" />
                <span>{loading ? '...' : `${totalVotes} Votes`}</span>
              </>
            )}
            {/* Barre de progression discrète en arrière-plan du bouton quand en recharge */}
            {timeLeft > 0 && (
              <div 
                className="absolute bottom-0 left-0 h-1 bg-indigo-500/30 transition-all duration-1000" 
                style={{ width: `${(timeLeft / VOTE_COOLDOWN) * 100}%` }}
              />
            )}
          </button>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-10 w-full">
          <div className="group bg-white/[0.02] border border-white/5 p-10 rounded-[40px] hover:bg-white/[0.04] transition-all hover:border-white/10">
            <div className="w-14 h-14 bg-indigo-600/10 rounded-2xl flex items-center justify-center mb-8 text-indigo-400 group-hover:scale-110 transition-transform">
              <Shield size={32} />
            </div>
            <h3 className="text-2xl font-bold mb-4">Modération</h3>
            <p className="text-slate-500 leading-relaxed text-lg">Sécurisez votre serveur avec des algorithmes de détection automatique de pointe.</p>
          </div>

          <div className="group bg-white/[0.02] border border-white/5 p-10 rounded-[40px] hover:bg-white/[0.04] transition-all hover:border-white/10">
            <div className="w-14 h-14 bg-blue-600/10 rounded-2xl flex items-center justify-center mb-8 text-blue-400 group-hover:scale-110 transition-transform">
              <Zap size={32} />
            </div>
            <h3 className="text-2xl font-bold mb-4">Performance</h3>
            <p className="text-slate-500 leading-relaxed text-lg">Une infrastructure robuste garantissant une disponibilité de 99.9% pour vos membres.</p>
          </div>

          <div className="group bg-white/[0.02] border border-white/5 p-10 rounded-[40px] hover:bg-white/[0.04] transition-all hover:border-white/10">
            <div className="w-14 h-14 bg-purple-600/10 rounded-2xl flex items-center justify-center mb-8 text-purple-400 group-hover:scale-110 transition-transform">
              <Users size={32} />
            </div>
            <h3 className="text-2xl font-bold mb-4">Engagement</h3>
            <p className="text-slate-500 leading-relaxed text-lg">Systèmes de niveaux et d'économie personnalisables pour animer votre communauté.</p>
          </div>
        </div>

        <footer className="mt-40 pb-16 text-center w-full border-t border-white/5 pt-12">
          <p className="text-slate-500 text-lg font-medium">
            Copyright © ShBot - 2026 • Propulsé par <span className="text-slate-300">ShauneSama</span>
          </p>
          <div className="mt-6 flex justify-center items-center gap-4 text-xs text-slate-600 uppercase tracking-[0.2em]">
            <span>Status: Operational</span>
            <span className="w-1 h-1 bg-emerald-500 rounded-full animate-pulse"></span>
            <span>ID: 1441774756687777802</span>
          </div>
        </footer>
      </main>
    </div>
  );
}

